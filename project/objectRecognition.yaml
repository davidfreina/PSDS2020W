---
name: "objectRecognition"
dataIns:
  - name: "videoBucketId"
    type: "string"
    source: "videoBucketId"
  - name: "numberOfFramesToAnalyzePerInstance"
    type: "number"
    source: "numberOfFramesToAnalyzePerInstance"
workflowBody:
  - function:
      name: "getVideoLinks"
      type: "getVideoLinksType"
      dataIns:
        - name: "videoBucketId"
          type: "string"
          source: "objectRecognition/videoBucketId"
      properties:
        - name: "resource"
          value: "nodejs:arn:aws:lambda:us-east-1:722672042190:function:video_links"
      dataOuts:
        - name: "videoLinks"
          type: "collection"
        - name: "numberOfVideos"
          type: "number"
  - parallelFor:
      name: "extractFramesParallel"
      dataIns:
        - name: "videoLinks"
          type: "collection"
          source: "getVideoLinks/videoLinks"
          constraints:
            - name: "distribution"
              value: "BLOCK(1)"
        - name: "numberOfVideos"
          type: "number"
          source: "getVideoLinks/numberOfVideos"
          constraints:
            - name: "distribution"
              value: "REPLICATE(*)"
      loopCounter:
        name: "counter"
        type: "number"
        from: "0"
        to: "getVideoLinks/numberOfVideos"
        step: "1"
      loopBody:
        - function:
            name: "extractFrames"
            type: "extractFramesType"
            dataIns:
              - name: "videoLinks"
                type: "string"
                source: "extractFramesParallel/videoLinks"
              - name: "numberOfVideos"
                type: "number"
                source: "extractFramesParallel/numberOfVideos"
                passing: true
            dataOuts:
              - name: "extractedFramesSplitFolders"
                type: "collection"
              - name: "numberOfVideos"
                type: "number"
            properties:
              - name: "resource"
                value: "nodejs:arn:aws:lambda:us-east-1:778033607199:function:extractFrames"
      dataOuts:
        # - name: "extractFramesSuccess"
        #   type: "collection"
        #   source: "extractFrames/extractFramesSuccess"
        #   constraints:
        #     - name: "aggregation"
        #       value: "+"
        - name: "extractedFramesSplitFoldersCombined"
          type: "collection"
          source: "extractFrames/extractedFramesSplitFolders"
          constraints:
            - name: "aggregation"
              value: "+"
        - name: "numberOfVideos"
          type: "number"
          source: "extractFrames/numberOfVideos"
  - parallelFor:
      name: "analyzeFramesParallel"
      dataIns:
        - name: "extractedFramesSplitFoldersCombined"
          type: "string"
          source: "extractFramesParallel/extractedFramesSplitFoldersCombined"
          constraints:
            - name: "distribution"
              value: "BLOCK(1)"
        - name: "numberOfVideos"
          type: "number"
          source: "extractFramesParallel/numberOfVideos"
          constraints:
            - name: "distribution"
              value: "REPLICATE(*)"
      loopCounter:
        name: "counter"
        type: "number"
        from: "0"
        to: "extractFramesParallel/numberOfVideos"
        step: "1"
      loopBody:
        - function:
            name: "analyzeFrames"
            type: "analyzeFramesType"
            dataIns:
              - name: "extractedFramesSplitFolder"
                type: "string"
                source: "analyzeFramesParallel/extractedFramesSplitFoldersCombined"
              - name: "numberOfVideos"
                type: "number"
                source: "analyzeFramesParallel/numberOfVideos"
                passing: true
            dataOuts:
              - name: "analyzeFramesSplitFolder"
                type: "string"
              - name: "numberOfVideos"
                type: "number"
            properties:
              - name: "resource"
                value: "nodejs:arn:aws:lambda:us-east-1:778033607199:function:analyzeFrames"
      dataOuts:
        - name: "analyzeFramesSplitFolderCombined"
          type: "collection"
          source: "analyzeFrames/analyzeFramesSplitFolder"
          constraints:
            - name: "aggregation"
              value: "+"
        - name: "numberOfVideos"
          type: "number"
          source: "analyzeFrames/numberOfVideos"
  - parallelFor:
      name: "awsRekognitionParallel"
      dataIns:
        - name: "analyzeFramesSplitFolderCombined"
          type: "collection"
          source: "analyzeFramesParallel/analyzeFramesSplitFolderCombined"
          constraints:
            - name: "distribution"
              value: "BLOCK(1)"
        # - name: "extractedFramesBucketsCollection"
        #   type: "collection"
        #   source: "analyzeFramesParallel/extractedFramesBucketCollection"
        #   constraints:
        #     - name: "distribution"
        #       value: "BLOCK(1)"
      loopCounter:
        name: "counter"
        type: "number"
        from: "0"
        to: "analyzeFramesParallel/numberOfVideos"
        step: "1"
      loopBody:
        - function:
            name: "awsRekognition"
            type: "awsRekognitionType"
            dataIns:
              - name: "analyzeFramesSplitFolder"
                type: "string"
                source: "awsRekognitionParallel/analyzeFramesSplitFolderCombined"
              # - name: "extractedFramesBucketsCollection"
              #   type: "collection"
              #   source: "awsRekognitionParallel/extractedFramesBucketsCollection"
            dataOuts:
              - name: "detections"
                type: "collection"
            properties:
              - name: "resource"
                value: "nodejs:arn:aws:lambda:us-east-1:778033607199:function:awsRekognition"
      dataOuts:
        - name: "humanSentenceCollection"
          type: "collection"
          source: "awsRekognition/humanSentence"
          constraints:
            - name: "aggregation"
              value: "+"